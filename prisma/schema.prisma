generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Hub {
  id               String            @id @default(uuid())
  name             String            @db.VarChar(100)
  code             String            @unique @db.VarChar(20)
  address          String?
  contact_person   String?           @db.VarChar(100)
  contact_phone    String?           @db.VarChar(15)
  contact_email    String?           @db.VarChar(100)
  status           HubStatus         @default(ACTIVE)
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  city             String?           @db.VarChar(100)
  country          String?           @db.VarChar(100)
  postal_code      String?           @db.VarChar(20)
  state            String?           @db.VarChar(100)
  parcels          Parcel[]
  storageLocations StorageLocation[]
  users            User[]

  @@index([code])
  @@index([status])
  @@index([city])
  @@map("hubs")
}

model User {
  id                 String         @id @default(uuid())
  full_name          String         @db.VarChar(100)
  email              String?        @unique @db.VarChar(100)
  phone              String         @unique @db.VarChar(15)
  password_hash      String         @db.VarChar(255)
  role               UserRole       @default(RECIPIENT)
  status             UserStatus     @default(ACTIVE)
  last_login_at      DateTime?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  hub_id             String?
  reset_token        String?        @db.VarChar(255)
  reset_token_expiry DateTime?
  notifications      Notification[]
  checkedInParcels   Parcel[]       @relation("OperatorCheckIn")
  checkedOutParcels  Parcel[]       @relation("OperatorCheckOut")
  parcels            Parcel[]       @relation("RecipientParcels")
  payments           Payment[]
  hub                Hub?           @relation(fields: [hub_id], references: [id])

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([hub_id])
  @@index([reset_token])
  @@map("users")
}

model Parcel {
  id                  String         @id @default(uuid())
  tracking_id         String         @unique @db.VarChar(50)
  recipient_id        String?
  recipient_name      String         @db.VarChar(100)
  recipient_phone     String         @db.VarChar(15)
  recipient_email     String?        @db.VarChar(100)
  status              ParcelStatus   @default(EXPECTED)
  weight_kg           Float?
  storage_location    String?        @db.VarChar(20)
  storage_zone        String?        @db.VarChar(10)
  photo_url           String?        @db.VarChar(500)
  fee_amount          Float?         @default(0)
  payment_status      PaymentStatus  @default(UNPAID)
  checked_in_at       DateTime?
  checked_in_by_id    String?
  checked_out_at      DateTime?
  checked_out_by_id   String?
  notes               String?
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  hub_id              String?
  arrived_at          DateTime?
  cancellation_reason String?
  cancelled_at        DateTime?
  collected_at        DateTime?
  notifications       Notification[]
  checkedInBy         User?          @relation("OperatorCheckIn", fields: [checked_in_by_id], references: [id])
  checkedOutBy        User?          @relation("OperatorCheckOut", fields: [checked_out_by_id], references: [id])
  hub                 Hub?           @relation(fields: [hub_id], references: [id])
  recipient           User?          @relation("RecipientParcels", fields: [recipient_id], references: [id])
  payments            Payment[]
  trackingLogs        TrackingLog[]

  @@index([tracking_id])
  @@index([recipient_id])
  @@index([recipient_phone])
  @@index([hub_id])
  @@index([status])
  @@index([created_at])
  @@map("parcels")
}

model TrackingLog {
  id          String   @id @default(uuid())
  parcel_id   String
  status      String   @db.VarChar(50)
  description String?
  created_by  String?  @db.VarChar(100)
  created_at  DateTime @default(now())
  parcel      Parcel   @relation(fields: [parcel_id], references: [id], onDelete: Cascade)

  @@index([parcel_id])
  @@index([created_at])
  @@map("tracking_logs")
}

model Payment {
  id             String        @id @default(uuid())
  parcel_id      String
  user_id        String?
  amount         Float
  payment_method PaymentMethod @default(CASH)
  payment_status PaymentStatus @default(PAID)
  transaction_id String?       @unique @db.VarChar(100)
  notes          String?
  created_at     DateTime      @default(now())
  parcel         Parcel        @relation(fields: [parcel_id], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [user_id], references: [id])

  @@index([parcel_id])
  @@index([user_id])
  @@index([created_at])
  @@map("payments")
}

model Notification {
  id            String              @id @default(uuid())
  user_id       String?
  parcel_id     String?
  type          NotificationType
  channel       NotificationChannel
  recipient     String              @db.VarChar(100)
  subject       String?             @db.VarChar(200)
  message       String
  status        NotificationStatus  @default(PENDING)
  sent_at       DateTime?
  error_message String?
  created_at    DateTime            @default(now())
  parcel        Parcel?             @relation(fields: [parcel_id], references: [id])
  user          User?               @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([parcel_id])
  @@index([status])
  @@index([created_at])
  @@map("notifications")
}

model StorageLocation {
  id          String   @id @default(uuid())
  zone        String   @db.VarChar(10)
  code        String   @unique @db.VarChar(20)
  description String?  @db.VarChar(200)
  capacity    Int      @default(1)
  is_occupied Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  hub_id      String?
  hub         Hub?     @relation(fields: [hub_id], references: [id])

  @@index([hub_id])
  @@index([zone])
  @@index([is_occupied])
  @@map("storage_locations")
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique @db.VarChar(100)
  value       String
  description String?  @db.VarChar(500)
  updated_at  DateTime @updatedAt

  @@map("system_settings")
}

enum HubStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum UserRole {
  RECIPIENT
  OPERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ParcelStatus {
  EXPECTED
  ARRIVED_UNCLAIMED
  READY_FOR_PICKUP
  COLLECTED
  RETURNED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  EWALLET
  ONLINE_BANKING
}

enum NotificationType {
  PARCEL_MATCHED
  PARCEL_READY
  PARCEL_WARNING
  PARCEL_RETURN
  PARCEL_COLLECTED
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
  SMS
  SYSTEM
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}
